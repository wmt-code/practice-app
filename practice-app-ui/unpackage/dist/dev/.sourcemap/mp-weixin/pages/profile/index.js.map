{"version":3,"file":"index.js","sources":["pages/profile/index.vue","D:/HBuilderX.4.85.2025110510/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9pbmRleC52dWU"],"sourcesContent":["<template>\r\n  <view class=\"page\">\r\n    <uni-card :is-shadow=\"false\" class=\"profile-card\">\r\n      <view class=\"profile-header\">\r\n        <image :src=\"user.avatar || '/static/uni.png'\" class=\"avatar\" mode=\"aspectFill\" />\r\n        <view class=\"info\">\r\n          <view class=\"nickname\">{{ user.nickname || '未登录' }}</view>\r\n          <view class=\"row\">\r\n            <uni-badge text=\"积分\" type=\"primary\" />\r\n            <text class=\"muted\"> {{ user.points || 0 }}</text>\r\n          </view>\r\n        </view>\r\n        <button size=\"mini\" type=\"primary\" class=\"login-btn\" @tap=\"handleWeixinLogin\">\r\n          {{ user.loggedIn ? '重新登录' : '微信登录' }}\r\n        </button>\r\n      </view>\r\n    </uni-card>\r\n\r\n    <uni-card title=\"个人信息\" :is-shadow=\"false\">\n      <uni-forms ref=\"formRef\" :modelValue=\"formModel\" :rules=\"rules\" label-position=\"top\">\n        <uni-forms-item label=\"昵称\" name=\"nickname\">\n          <uni-easyinput v-model=\"formModel.nickname\" placeholder=\"请输入昵称\" />\n        </uni-forms-item>\n        <uni-forms-item label=\"头像 URL\" name=\"avatar\">\n          <uni-easyinput v-model=\"formModel.avatar\" placeholder=\"可填写自定义头像链接\" />\n        </uni-forms-item>\n        <uni-forms-item label=\"邮箱\" name=\"email\">\n          <uni-easyinput v-model=\"formModel.email\" placeholder=\"邮箱（可选）\" />\n        </uni-forms-item>\n      </uni-forms>\n      <button type=\"primary\" class=\"primary-btn\" @tap=\"handleSave\">保存修改</button>\n    </uni-card>\n\r\n    <uni-card title=\"学习进度\" :is-shadow=\"false\">\r\n      <view class=\"stats-row\">\r\n        <view class=\"stat\">\r\n          <text class=\"stat-num\">{{ progress.answeredQuestions }}</text>\r\n          <text class=\"muted\">已完成</text>\r\n        </view>\r\n        <view class=\"stat\">\r\n          <text class=\"stat-num\">{{ progress.totalQuestions }}</text>\r\n          <text class=\"muted\">总题量</text>\r\n        </view>\r\n        <view class=\"stat\">\r\n          <text class=\"stat-num\">{{ progress.correctRate }}%</text>\r\n          <text class=\"muted\">正确率</text>\r\n        </view>\r\n      </view>\r\n      <button class=\"ghost-btn\" @tap=\"goRecords\">查看答题记录</button>\r\n    </uni-card>\r\n  </view>\r\n</template>\r\n\r\n<script setup>\nimport { reactive, ref } from 'vue';\nimport { onShow } from '@dcloudio/uni-app';\nimport { wechatLogin } from '@/api/auth';\nimport { emptyProgress, fetchProgressSummary } from '@/api/progress';\nimport { fetchProfile, getCachedProfile, normalizeUser, updateProfile } from '@/api/user';\n\nconst defaultUser = {\n  nickname: '未登录',\n  avatar: '/static/uni.png',\n  loggedIn: false,\n  points: 0,\n};\n\nconst fallbackUser = () => normalizeUser(getCachedProfile()) || defaultUser;\n\nconst user = ref(fallbackUser());\nconst progress = ref(emptyProgress());\n\nconst formModel = reactive({\n  nickname: user.value?.nickname || '',\n  avatar: user.value?.avatar || '',\n  email: user.value?.email || '',\n});\n\nconst rules = {\n  nickname: {\n    rules: [{ required: true, errorMessage: '请输入昵称' }],\n  },\n};\n\nconst formRef = ref(null);\n\nconst loadData = async () => {\n  try {\n    const profile = await fetchProfile();\n    user.value = profile || fallbackUser();\n  } catch (err) {\n    user.value = fallbackUser();\n  }\n  formModel.nickname = user.value.nickname || '';\n  formModel.avatar = user.value.avatar || '';\n  formModel.email = user.value.email || '';\n  try {\n    progress.value = await fetchProgressSummary();\n  } catch (err) {\n    progress.value = emptyProgress();\n  }\n};\n\nconst getWxProfile = async () => {\n  if (!uni.getUserProfile) return {};\n  const res = await uni.getUserProfile({ desc: '用于完善个人资料' });\n  return res?.userInfo || {};\n};\n\nconst handleWeixinLogin = async () => {\n  try {\n    uni.showLoading({ title: '登录中' });\n    const profile = await getWxProfile().catch(() => ({}));\n    const resp = await wechatLogin({\n      nickname: profile.nickName || profile.nickname,\n      avatar: profile.avatarUrl || profile.avatar,\n    });\n    user.value = resp.user || fallbackUser();\n    await loadData();\n    uni.showToast({ title: '登录成功', icon: 'success' });\n  } catch (err) {\n    console.error(err);\n    uni.showToast({ title: err.message || '登录失败，稍后再试', icon: 'none' });\n  } finally {\n    uni.hideLoading();\n  }\n};\n\nconst handleSave = async () => {\n  if (!formRef.value) return;\n  try {\n    await formRef.value.validate();\n    if (formModel.email && !/^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$/.test(formModel.email)) {\n      uni.showToast({ title: '邮箱格式不正确', icon: 'none' });\n      return;\n    }\n    const info = await updateProfile({\n      nickname: formModel.nickname,\n      avatar: formModel.avatar,\n      email: formModel.email,\n    });\n    user.value = info || fallbackUser();\n    uni.showToast({ title: '保存成功', icon: 'success' });\n  } catch (err) {\n    if (err?.errMsg) {\n      uni.showToast({ title: err.errMsg, icon: 'none' });\n    } else {\n      uni.showToast({ title: '保存失败', icon: 'none' });\r\n    }\r\n  }\r\n};\r\n\r\nconst goRecords = () => {\r\n  uni.switchTab({ url: '/pages/records/index' });\r\n};\r\n\r\nonShow(() => {\r\n  loadData();\r\n});\r\n</script>\r\n\r\n<style lang=\"scss\" scoped>\r\n.page {\r\n  padding: 20rpx;\r\n}\r\n\r\n.profile-card {\r\n  background: linear-gradient(135deg, #1f2937, #111827);\r\n  color: #fff;\r\n}\r\n\r\n.profile-header {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 16rpx;\r\n}\r\n\r\n.avatar {\r\n  width: 120rpx;\r\n  height: 120rpx;\r\n  border-radius: 50%;\r\n  border: 4rpx solid rgba(255, 255, 255, 0.3);\r\n}\r\n\r\n.info {\r\n  flex: 1;\r\n  display: flex;\r\n  flex-direction: column;\r\n  gap: 8rpx;\r\n}\r\n\r\n.nickname {\r\n  font-size: 32rpx;\r\n  font-weight: 700;\r\n}\r\n\r\n.row {\r\n  display: flex;\r\n  align-items: center;\r\n  gap: 10rpx;\r\n}\r\n\r\n.login-btn {\r\n  background: #2563eb;\r\n  color: #fff;\r\n}\r\n\r\n.primary-btn {\r\n  width: 100%;\r\n  margin-top: 12rpx;\r\n  background: linear-gradient(135deg, #2563eb, #1d4ed8);\r\n}\r\n\r\n.ghost-btn {\r\n  width: 100%;\r\n  margin-top: 12rpx;\r\n  background: #f3f4f6;\r\n  color: #1f2937;\r\n}\r\n\r\n.stats-row {\r\n  display: grid;\r\n  grid-template-columns: repeat(3, 1fr);\r\n  gap: 12rpx;\r\n  text-align: center;\r\n}\r\n\r\n.stat-num {\r\n  font-size: 32rpx;\r\n  font-weight: 700;\r\n}\r\n\r\n.muted {\r\n  color: #6b7280;\r\n}\r\n</style>\r\n","import MiniProgramPage from 'E:/project/practice-app/practice-app-ui/pages/profile/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["normalizeUser","getCachedProfile","ref","emptyProgress","reactive","fetchProfile","fetchProgressSummary","uni","wechatLogin","updateProfile","onShow"],"mappings":"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"}