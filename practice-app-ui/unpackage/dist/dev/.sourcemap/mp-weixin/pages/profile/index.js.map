{"version":3,"file":"index.js","sources":["pages/profile/index.vue","D:/HBuilderX.4.85.2025110510/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvcHJvZmlsZS9pbmRleC52dWU"],"sourcesContent":["• <template>\n    <view class=\"page\">\n      <uni-card :is-shadow=\"false\" class=\"profile-card\">\n        <view class=\"profile-header\">\n          <image :src=\"previewAvatar\" class=\"avatar\" mode=\"aspectFill\" />\n          <view class=\"info\">\n            <view class=\"nickname\">{{ user.nickname || '未登录' }}</view>\n            <view class=\"row\">\n              <uni-badge text=\"积分\" type=\"primary\" />\n              <text class=\"muted\"> {{ user.points || 0 }}</text>\n            </view>\n          </view>\n          <button size=\"mini\" type=\"primary\" class=\"login-btn\" @tap=\"handleWeixinLogin\">\n            {{ user.loggedIn ? '重新登录' : '微信登录' }}\n          </button>\n        </view>\n      </uni-card>\n\n      <uni-card title=\"个人信息\" :is-shadow=\"false\">\n        <uni-forms ref=\"formRef\" :modelValue=\"formModel\" :rules=\"rules\" label-position=\"top\">\n          <uni-forms-item label=\"昵称\" name=\"nickname\">\n            <!-- #ifdef MP-WEIXIN -->\n            <input\n              class=\"uni-input\"\n              type=\"nickname\"\n              :value=\"formModel.nickname\"\n              placeholder=\"点击上方按钮可一键使用微信昵称\"\n              @input=\"(e) => (formModel.nickname = e.detail.value)\"\n            />\n            <!-- #endif -->\n            <!-- #ifndef MP-WEIXIN -->\n            <uni-easyinput v-model=\"formModel.nickname\" placeholder=\"请输入昵称\" />\n            <!-- #endif -->\n          </uni-forms-item>\n          <uni-forms-item label=\"头像 URL\" name=\"avatar\">\n            <uni-easyinput v-model=\"formModel.avatar\" placeholder=\"可填写自定义头像链接\" />\n          </uni-forms-item>\n          <uni-forms-item label=\"选择头像\" name=\"avatarLocal\">\n            <view class=\"avatar-row\">\n              <button\n                class=\"ghost-btn\"\n                size=\"mini\"\n                open-type=\"chooseAvatar\"\n                v-if=\"isWeixin\"\n                @chooseavatar=\"handleChooseAvatar\"\n              >\n                从微信头像选择\n              </button>\n              <button class=\"ghost-btn\" size=\"mini\" @tap=\"handleChooseImage\">从相册上传</button>\n            </view>\n            <view class=\"muted\">优先上传头像，其次使用填写的头像 URL</view>\n          </uni-forms-item>\n          <uni-forms-item label=\"邮箱\" name=\"email\">\n            <uni-easyinput v-model=\"formModel.email\" placeholder=\"邮箱（可选）\" />\n          </uni-forms-item>\n        </uni-forms>\n        <button type=\"primary\" class=\"primary-btn\" @tap=\"handleSave\">保存修改</button>\n      </uni-card>\n\n      <uni-card title=\"学习进度\" :is-shadow=\"false\">\n        <view class=\"stats-row\">\n          <view class=\"stat\">\n            <text class=\"stat-num\">{{ progress.answeredQuestions }}</text>\n            <text class=\"muted\">已完成</text>\n          </view>\n          <view class=\"stat\">\n            <text class=\"stat-num\">{{ progress.totalQuestions }}</text>\n            <text class=\"muted\">总题量</text>\n          </view>\n          <view class=\"stat\">\n            <text class=\"stat-num\">{{ progress.correctRate }}%</text>\n            <text class=\"muted\">正确率</text>\n          </view>\n        </view>\n        <button class=\"ghost-btn\" @tap=\"goRecords\">查看答题记录</button>\n    </uni-card>\n\n    <view v-if=\"showProfileCard\" class=\"overlay\">\n      <view class=\"profile-popup\">\n        <view class=\"popup-title\">完善头像昵称</view>\n        <view class=\"row popup-row\">\n          <image :src=\"previewAvatar\" class=\"avatar\" mode=\"aspectFill\" />\n          <view class=\"muted\">选择头像并填写昵称后保存</view>\n        </view>\n        <view class=\"avatar-row\">\n          <button\n            class=\"ghost-btn\"\n            size=\"mini\"\n            open-type=\"chooseAvatar\"\n            v-if=\"isWeixin\"\n            @chooseavatar=\"handleChooseAvatar\"\n          >\n            从微信头像选择\n          </button>\n          <button class=\"ghost-btn\" size=\"mini\" @tap=\"handleChooseImage\">从相册上传</button>\n        </view>\n        <view class=\"popup-field\">\n          <!-- #ifdef MP-WEIXIN -->\n          <input\n            class=\"uni-input\"\n            type=\"nickname\"\n            :value=\"formModel.nickname\"\n            placeholder=\"点击选择微信昵称或手动输入\"\n            @input=\"(e) => (formModel.nickname = e.detail.value)\"\n          />\n          <!-- #endif -->\n          <!-- #ifndef MP-WEIXIN -->\n          <uni-easyinput v-model=\"formModel.nickname\" placeholder=\"请输入昵称\" />\n          <!-- #endif -->\n        </view>\n        <view class=\"popup-actions\">\n          <button class=\"ghost-btn\" @tap=\"closeProfileCard\">稍后再说</button>\n          <button type=\"primary\" class=\"primary-btn\" @tap=\"handleSave\">保存</button>\n        </view>\n      </view>\n    </view>\n  </view>\n</template>\n  <script setup>\n  import { reactive, ref, computed } from 'vue';\n  import { onShow } from '@dcloudio/uni-app';\n  import { wechatLogin } from '@/api/auth';\nimport { emptyProgress, fetchProgressSummary } from '@/api/progress';\nimport {\n  fetchProfile,\n  getCachedProfile,\n  normalizeUser,\n  updateProfile,\n  uploadAvatar,\n} from '@/api/user';\n\nconst defaultUser = {\n  nickname: '未登录',\n  avatar: '/static/uni.png',\n  loggedIn: false,\n  points: 0,\n};\n\n  const fallbackUser = () => normalizeUser(getCachedProfile()) || defaultUser;\n\nconst user = ref(fallbackUser());\nconst progress = ref(emptyProgress());\nconst isWeixin = ref(false);\nconst showProfileCard = ref(false);\n\n  const formModel = reactive({\n    nickname: user.value?.nickname || '',\n    avatar: user.value?.avatar || '',\n    email: user.value?.email || '',\n    avatarLocal: '',\n  });\n\n  const rules = {\n    nickname: {\n      rules: [{ required: true, errorMessage: '请输入昵称' }],\n    },\n  };\n\n  const formRef = ref(null);\n  const previewAvatar = computed(() => formModel.avatarLocal || formModel.avatar || '/static/uni.png');\n\n  const loadData = async () => {\n    try {\n      const profile = await fetchProfile();\n      user.value = profile || fallbackUser();\n    } catch (err) {\n      user.value = fallbackUser();\n    }\n    formModel.nickname = user.value.nickname || '';\n    formModel.avatar = user.value.avatar || '';\n    formModel.email = user.value.email || '';\n    try {\n      progress.value = await fetchProgressSummary();\n    } catch (err) {\n      progress.value = emptyProgress();\n    }\n  };\n\n  const handleChooseAvatar = (e) => {\n    const avatarUrl = e?.detail?.avatarUrl;\n    if (avatarUrl) {\n      formModel.avatarLocal = avatarUrl;\n    }\n  };\n\n  const handleChooseImage = () => {\n    uni.chooseImage({\n      count: 1,\n      sizeType: ['compressed', 'original'],\n      success: (res) => {\n        const path = res.tempFilePaths?.[0];\n        if (path) {\n          formModel.avatarLocal = path;\n        }\n      },\n    });\n  };\n\nconst handleWeixinLogin = async () => {\n  try {\n    uni.showLoading({ title: '登录中' });\n    const resp = await wechatLogin();\n    user.value = resp.user || fallbackUser();\n    await loadData();\n    showProfileCard.value = true; // 登录后提示完善头像昵称\n    uni.showToast({ title: '登录成功', icon: 'success' });\n  } catch (err) {\n    console.error(err);\n    uni.showToast({ title: err.message || '登录失败，稍后再试', icon: 'none' });\n  } finally {\n    uni.hideLoading();\n    }\n  };\n\nconst handleSave = async () => {\n  if (!formRef.value) return;\n  try {\n    await formRef.value.validate();\n    if (formModel.email && !/^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$/.test(formModel.email)) {\n        uni.showToast({ title: '邮箱格式不正确', icon: 'none' });\n        return;\n      }\n      let avatarUrlToSave = formModel.avatar;\n      if (formModel.avatarLocal) {\n        avatarUrlToSave = await uploadAvatar(formModel.avatarLocal);\n      }\n    const info = await updateProfile({\n      nickname: formModel.nickname,\n      avatar: avatarUrlToSave,\n      email: formModel.email,\n    });\n    user.value = info || fallbackUser();\n    showProfileCard.value = false;\n    uni.showToast({ title: '保存成功', icon: 'success' });\n    return true;\n  } catch (err) {\n    if (err?.errMsg) {\n      uni.showToast({ title: err.errMsg, icon: 'none' });\n    } else {\n      uni.showToast({ title: '保存失败', icon: 'none' });\n    }\n    return false;\n  }\n};\n\nconst goRecords = () => {\n  uni.switchTab({ url: '/pages/records/index' });\n};\n\nconst closeProfileCard = () => {\n  showProfileCard.value = false;\n};\n\nonShow(() => {\n  try {\n    const info = uni.getSystemInfoSync && uni.getSystemInfoSync();\n    isWeixin.value = info?.uniPlatform === 'mp-weixin' || info?.appName === 'WeChat';\n  } catch (e) {\n      isWeixin.value = false;\n    }\n    loadData();\n  });\n  </script>\n  <style lang=\"scss\" scoped>\n  .page {\n    padding: 20rpx;\n  }\n\n  .profile-card {\n    background: linear-gradient(135deg, #1f2937, #111827);\n    color: #fff;\n  }\n\n  .profile-header {\n    display: flex;\n    align-items: center;\n    gap: 16rpx;\n  }\n\n  .avatar {\n    width: 120rpx;\n    height: 120rpx;\n    border-radius: 50%;\n    border: 4rpx solid rgba(255, 255, 255, 0.3);\n  }\n\n  .avatar-row {\n    display: flex;\n    gap: 12rpx;\n    flex-wrap: wrap;\n    margin-top: 8rpx;\n  }\n\n  .info {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 8rpx;\n  }\n\n  .nickname {\n    font-size: 32rpx;\n    font-weight: 700;\n  }\n\n  .row {\n    display: flex;\n    align-items: center;\n    gap: 10rpx;\n  }\n\n  .login-btn {\n    background: #2563eb;\n    color: #fff;\n  }\n\n  .primary-btn {\n    width: 100%;\n    margin-top: 12rpx;\n    background: linear-gradient(135deg, #2563eb, #1d4ed8);\n  }\n\n  .ghost-btn {\n    width: 100%;\n    margin-top: 12rpx;\n    background: #f3f4f6;\n    color: #1f2937;\n  }\n\n  .stats-row {\n    display: grid;\n    grid-template-columns: repeat(3, 1fr);\n    gap: 12rpx;\n    text-align: center;\n  }\n\n  .stat-num {\n    font-size: 32rpx;\n    font-weight: 700;\n  }\n\n.muted {\n  color: #6b7280;\n}\n\n.overlay {\n  position: fixed;\n  inset: 0;\n  background: rgba(0, 0, 0, 0.45);\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  z-index: 999;\n  padding: 20rpx;\n}\n\n.profile-popup {\n  background: #fff;\n  border-radius: 16rpx;\n  padding: 24rpx;\n  width: 100%;\n  max-width: 640rpx;\n  box-shadow: 0 12rpx 40rpx rgba(0, 0, 0, 0.18);\n}\n\n.popup-title {\n  font-size: 32rpx;\n  font-weight: 700;\n  margin-bottom: 16rpx;\n}\n\n.popup-row {\n  align-items: center;\n}\n\n.popup-field {\n  margin-top: 12rpx;\n}\n\n.popup-actions {\n  display: flex;\n  gap: 12rpx;\n  margin-top: 16rpx;\n}\n\n.uni-input {\n  width: 100%;\n  padding: 16rpx;\n  border: 1px solid #e5e7eb;\n  border-radius: 12rpx;\n  background: #fff;\n}\n  </style>\n","import MiniProgramPage from 'E:/project/practice-app/practice-app-ui/pages/profile/index.vue'\nwx.createPage(MiniProgramPage)"],"names":["normalizeUser","getCachedProfile","ref","emptyProgress","reactive","computed","fetchProfile","fetchProgressSummary","_a","uni","wechatLogin","uploadAvatar","updateProfile","onShow"],"mappings":"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"}