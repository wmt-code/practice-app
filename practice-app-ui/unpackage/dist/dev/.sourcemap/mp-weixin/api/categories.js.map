{"version":3,"file":"categories.js","sources":["api/categories.js"],"sourcesContent":["import { request } from './http';\r\n\r\nfunction normalizeNode(node = {}) {\r\n  return {\r\n    id: node.id,\r\n    name: node.name,\r\n    parentId: node.parentId,\r\n    badgeText: node.badgeText,\r\n    questionCount: node.questionCount || 0,\r\n    finishedCount: node.finishedCount || 0,\r\n    children: Array.isArray(node.children)\r\n      ? node.children.map((child) => normalizeNode(child))\r\n      : [],\r\n  };\r\n}\r\n\r\n// 简单缓存分类树，减少重复请求导致的等待\r\nlet cachedTree = null;\r\nlet cachedAt = 0;\r\nlet pendingPromise = null;\r\nconst CACHE_TTL = 60 * 1000; // 1 分钟\r\n\r\nfunction cloneTree(tree) {\r\n  return JSON.parse(JSON.stringify(tree));\r\n}\r\n\r\nexport async function fetchCategoryTree(force = false) {\r\n  const now = Date.now();\r\n  if (!force && cachedTree && now - cachedAt < CACHE_TTL) {\r\n    return cloneTree(cachedTree);\r\n  }\r\n  if (!force && pendingPromise) {\r\n    return cloneTree(await pendingPromise);\r\n  }\r\n  pendingPromise = request({ url: '/categories/tree', method: 'GET' }).then((tree) => {\r\n    if (!Array.isArray(tree)) return [];\r\n    const normalized = tree.map((item) => normalizeNode(item));\r\n    cachedTree = normalized;\r\n    cachedAt = Date.now();\r\n    return normalized;\r\n  }).finally(() => {\r\n    pendingPromise = null;\r\n  });\r\n  const result = await pendingPromise;\r\n  return cloneTree(result);\r\n}\r\n\r\nexport async function fetchCategories() {\r\n  const list = await request({ url: '/categories', method: 'GET' });\r\n  if (!Array.isArray(list)) return [];\r\n  return list.map((item) => ({\r\n    id: item.id,\r\n    name: item.name,\r\n    description: item.description,\r\n    parentId: item.parentId,\r\n    badgeText: item.badgeText,\r\n    sort: item.sort,\r\n  }));\r\n}\r\n\r\nexport function flattenCategoryTree(tree = []) {\r\n  const result = [];\r\n  const walk = (nodes) => {\r\n    (nodes || []).forEach((node) => {\r\n      result.push(node);\r\n      if (node.children && node.children.length) {\r\n        walk(node.children);\r\n      }\r\n    });\r\n  };\r\n  walk(tree);\r\n  return result;\r\n}\r\n\r\nexport function categoryNameById(list = [], id) {\r\n  return list.find((item) => String(item.id) === String(id))?.name || '';\r\n}\r\n"],"names":["request"],"mappings":";;AAEA,SAAS,cAAc,OAAO,IAAI;AAChC,SAAO;AAAA,IACL,IAAI,KAAK;AAAA,IACT,MAAM,KAAK;AAAA,IACX,UAAU,KAAK;AAAA,IACf,WAAW,KAAK;AAAA,IAChB,eAAe,KAAK,iBAAiB;AAAA,IACrC,eAAe,KAAK,iBAAiB;AAAA,IACrC,UAAU,MAAM,QAAQ,KAAK,QAAQ,IACjC,KAAK,SAAS,IAAI,CAAC,UAAU,cAAc,KAAK,CAAC,IACjD,CAAE;AAAA,EACV;AACA;AAGA,IAAI,aAAa;AACjB,IAAI,WAAW;AACf,IAAI,iBAAiB;AACrB,MAAM,YAAY,KAAK;AAEvB,SAAS,UAAU,MAAM;AACvB,SAAO,KAAK,MAAM,KAAK,UAAU,IAAI,CAAC;AACxC;AAEO,eAAe,kBAAkB,QAAQ,OAAO;AACrD,QAAM,MAAM,KAAK;AACjB,MAAI,CAAC,SAAS,cAAc,MAAM,WAAW,WAAW;AACtD,WAAO,UAAU,UAAU;AAAA,EAC5B;AACD,MAAI,CAAC,SAAS,gBAAgB;AAC5B,WAAO,UAAU,MAAM,cAAc;AAAA,EACtC;AACD,mBAAiBA,SAAAA,QAAQ,EAAE,KAAK,oBAAoB,QAAQ,OAAO,EAAE,KAAK,CAAC,SAAS;AAClF,QAAI,CAAC,MAAM,QAAQ,IAAI;AAAG,aAAO,CAAA;AACjC,UAAM,aAAa,KAAK,IAAI,CAAC,SAAS,cAAc,IAAI,CAAC;AACzD,iBAAa;AACb,eAAW,KAAK;AAChB,WAAO;AAAA,EACX,CAAG,EAAE,QAAQ,MAAM;AACf,qBAAiB;AAAA,EACrB,CAAG;AACD,QAAM,SAAS,MAAM;AACrB,SAAO,UAAU,MAAM;AACzB;AAEO,eAAe,kBAAkB;AACtC,QAAM,OAAO,MAAMA,SAAAA,QAAQ,EAAE,KAAK,eAAe,QAAQ,MAAK,CAAE;AAChE,MAAI,CAAC,MAAM,QAAQ,IAAI;AAAG,WAAO,CAAA;AACjC,SAAO,KAAK,IAAI,CAAC,UAAU;AAAA,IACzB,IAAI,KAAK;AAAA,IACT,MAAM,KAAK;AAAA,IACX,aAAa,KAAK;AAAA,IAClB,UAAU,KAAK;AAAA,IACf,WAAW,KAAK;AAAA,IAChB,MAAM,KAAK;AAAA,EACZ,EAAC;AACJ;AAEO,SAAS,oBAAoB,OAAO,IAAI;AAC7C,QAAM,SAAS,CAAA;AACf,QAAM,OAAO,CAAC,UAAU;AACtB,KAAC,SAAS,CAAA,GAAI,QAAQ,CAAC,SAAS;AAC9B,aAAO,KAAK,IAAI;AAChB,UAAI,KAAK,YAAY,KAAK,SAAS,QAAQ;AACzC,aAAK,KAAK,QAAQ;AAAA,MACnB;AAAA,IACP,CAAK;AAAA,EACL;AACE,OAAK,IAAI;AACT,SAAO;AACT;AAEO,SAAS,iBAAiB,OAAO,CAAE,GAAE,IAAI;;AAC9C,WAAO,UAAK,KAAK,CAAC,SAAS,OAAO,KAAK,EAAE,MAAM,OAAO,EAAE,CAAC,MAAlD,mBAAqD,SAAQ;AACtE;;;;;"}