{"version":3,"file":"auth.js","sources":["api/auth.js"],"sourcesContent":["import { clearTokens, getStoredUser, request, setStoredUser, setTokens } from './http';\nimport { normalizeUser } from './user';\n\nexport async function getWxCode() {\n  return new Promise((resolve, reject) => {\n    // #ifdef MP-WEIXIN\n    if (!uni || !uni.login) {\n      reject(new Error('uni.login 不存在，当前不是正确的小程序运行环境'));\n      return;\n    }\n\n    uni.login({\n      // provider 在微信小程序里写不写都行，这里保留也没问题\n      provider: 'weixin',\n      success: (res) => {\n        console.log('uni.login success 原始返回：', res);\n        const { code } = res || {};\n        if (code) {\n          console.log('获取到登录 code：', code);\n          resolve(code);\n        } else {\n          reject(new Error('uni.login 调用成功，但未获取到 code'));\n        }\n      },\n      fail: (err) => {\n        console.log('uni.login fail：', err);\n        reject(err);\n      },\n    });\n    // #endif\n\n    // #ifndef MP-WEIXIN\n    reject(new Error('当前不是微信小程序环境（MP-WEIXIN）'));\n    // #endif\n  });\n}\n\nexport async function wechatLogin({ code, nickname, avatar } = {}) {\n  const ensuredCode = code || (await getWxCode());\n  const data = await request({\n    url: '/auth/wechat',\n    method: 'POST',\n    data: { code: ensuredCode, nickname, avatar },\n    auth: false,\n  });\n  const normalizedUser = normalizeUser(data?.user);\n  if (data?.accessToken) {\n    setTokens(data.accessToken, data.refreshToken);\n  }\n  if (normalizedUser) {\n    setStoredUser(normalizedUser);\n  }\n  return { ...data, user: normalizedUser };\n}\n\nexport function logout() {\n  clearTokens();\n  setStoredUser(null);\n  return getStoredUser();\n}\n"],"names":["uni","request","normalizeUser","setTokens","setStoredUser"],"mappings":";;;;AAGO,eAAe,YAAY;AAChC,SAAO,IAAI,QAAQ,CAAC,SAAS,WAAW;AAEtC,QAAI,CAACA,cAAG,SAAI,CAACA,cAAG,MAAC,OAAO;AACtB,aAAO,IAAI,MAAM,8BAA8B,CAAC;AAChD;AAAA,IACD;AAEDA,kBAAAA,MAAI,MAAM;AAAA;AAAA,MAER,UAAU;AAAA,MACV,SAAS,CAAC,QAAQ;AAChBA,sBAAA,MAAA,MAAA,OAAA,qBAAY,2BAA2B,GAAG;AAC1C,cAAM,EAAE,KAAI,IAAK,OAAO;AACxB,YAAI,MAAM;AACRA,wBAAA,MAAA,MAAA,OAAA,qBAAY,eAAe,IAAI;AAC/B,kBAAQ,IAAI;AAAA,QACtB,OAAe;AACL,iBAAO,IAAI,MAAM,2BAA2B,CAAC;AAAA,QAC9C;AAAA,MACF;AAAA,MACD,MAAM,CAAC,QAAQ;AACbA,sBAAA,MAAA,MAAA,OAAA,qBAAY,mBAAmB,GAAG;AAClC,eAAO,GAAG;AAAA,MACX;AAAA,IACP,CAAK;AAAA,EAML,CAAG;AACH;AAEO,eAAe,YAAY,EAAE,MAAM,UAAU,OAAM,IAAK,CAAA,GAAI;AACjE,QAAM,cAAc,QAAS,MAAM,UAAW;AAC9C,QAAM,OAAO,MAAMC,iBAAQ;AAAA,IACzB,KAAK;AAAA,IACL,QAAQ;AAAA,IACR,MAAM,EAAE,MAAM,aAAa,UAAU,OAAQ;AAAA,IAC7C,MAAM;AAAA,EACV,CAAG;AACD,QAAM,iBAAiBC,SAAAA,cAAc,6BAAM,IAAI;AAC/C,MAAI,6BAAM,aAAa;AACrBC,aAAAA,UAAU,KAAK,aAAa,KAAK,YAAY;AAAA,EAC9C;AACD,MAAI,gBAAgB;AAClBC,aAAa,cAAC,cAAc;AAAA,EAC7B;AACD,SAAO,EAAE,GAAG,MAAM,MAAM,eAAc;AACxC;;"}