{"version":3,"file":"user.js","sources":["api/user.js"],"sourcesContent":["import { request, getStoredUser, setStoredUser, upload } from './http';\n\nconst DEFAULT_AVATAR = '/static/uni.png';\n\nexport function normalizeUser(user) {\n  if (!user) {\n    return null;\n  }\n  return {\n    ...user,\n    nickname: user.nickname || user.username || '未登录',\n    avatar: user.avatar || DEFAULT_AVATAR,\n    loggedIn: !!user.id,\n    points: user.points ?? 0,\n  };\n}\n\nexport async function fetchProfile() {\n  const user = await request({ url: '/user/me', method: 'GET' });\n  const normalized = normalizeUser(user);\n  if (normalized) {\n    setStoredUser(normalized);\n  }\n  return normalized;\n}\n\nexport async function updateProfile(payload = {}) {\n  const data = {\n    nickname: payload.nickname,\n    avatar: payload.avatar,\n  };\n  if (payload.email) {\n    data.email = payload.email;\n  }\n  await request({ url: '/user/me', method: 'PUT', data });\n  return fetchProfile();\n}\n\nexport function getCachedProfile() {\n  const stored = getStoredUser();\n  return stored ? normalizeUser(stored) : null;\n}\n\nexport async function uploadAvatar(filePath) {\n  if (!filePath) {\n    throw new Error('缺少头像文件路径');\n  }\n  const res = await upload({ url: '/user/me/avatar', filePath, name: 'file' });\n  if (typeof res === 'string') return res;\n  if (res?.url) return res.url;\n  return res;\n}\n"],"names":["request","setStoredUser","getStoredUser","upload"],"mappings":";;AAEA,MAAM,iBAAiB;AAEhB,SAAS,cAAc,MAAM;AAClC,MAAI,CAAC,MAAM;AACT,WAAO;AAAA,EACR;AACD,SAAO;AAAA,IACL,GAAG;AAAA,IACH,UAAU,KAAK,YAAY,KAAK,YAAY;AAAA,IAC5C,QAAQ,KAAK,UAAU;AAAA,IACvB,UAAU,CAAC,CAAC,KAAK;AAAA,IACjB,QAAQ,KAAK,UAAU;AAAA,EAC3B;AACA;AAEO,eAAe,eAAe;AACnC,QAAM,OAAO,MAAMA,SAAAA,QAAQ,EAAE,KAAK,YAAY,QAAQ,MAAK,CAAE;AAC7D,QAAM,aAAa,cAAc,IAAI;AACrC,MAAI,YAAY;AACdC,aAAa,cAAC,UAAU;AAAA,EACzB;AACD,SAAO;AACT;AAEO,eAAe,cAAc,UAAU,IAAI;AAChD,QAAM,OAAO;AAAA,IACX,UAAU,QAAQ;AAAA,IAClB,QAAQ,QAAQ;AAAA,EACpB;AACE,MAAI,QAAQ,OAAO;AACjB,SAAK,QAAQ,QAAQ;AAAA,EACtB;AACD,QAAMD,SAAAA,QAAQ,EAAE,KAAK,YAAY,QAAQ,OAAO,KAAI,CAAE;AACtD,SAAO,aAAY;AACrB;AAEO,SAAS,mBAAmB;AACjC,QAAM,SAASE,SAAAA;AACf,SAAO,SAAS,cAAc,MAAM,IAAI;AAC1C;AAEO,eAAe,aAAa,UAAU;AAC3C,MAAI,CAAC,UAAU;AACb,UAAM,IAAI,MAAM,UAAU;AAAA,EAC3B;AACD,QAAM,MAAM,MAAMC,SAAM,OAAC,EAAE,KAAK,mBAAmB,UAAU,MAAM,OAAM,CAAE;AAC3E,MAAI,OAAO,QAAQ;AAAU,WAAO;AACpC,MAAI,2BAAK;AAAK,WAAO,IAAI;AACzB,SAAO;AACT;;;;;;"}