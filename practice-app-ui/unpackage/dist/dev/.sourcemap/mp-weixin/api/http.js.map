{"version":3,"file":"http.js","sources":["api/http.js"],"sourcesContent":["const ACCESS_TOKEN_KEY = 'practice_app_access_token';\nconst REFRESH_TOKEN_KEY = 'practice_app_refresh_token';\nconst USER_CACHE_KEY = 'practice_app_user';\n\nconst DEFAULT_BASE = 'http://localhost:8888/api';\n\nconst API_BASE = (() => {\n  let base = DEFAULT_BASE;\n  try {\n    if (typeof import.meta !== 'undefined' && import.meta.env && import.meta.env.VITE_API_BASE_URL) {\n      base = import.meta.env.VITE_API_BASE_URL;\n    } else if (typeof process !== 'undefined' && process.env && process.env.API_BASE_URL) {\n      base = process.env.API_BASE_URL;\n    }\n  } catch (err) {\n    // ignore env resolution errors\n  }\n  return (base || DEFAULT_BASE).replace(/\\/$/, '');\n})();\n\nfunction safeGetStorage(key) {\n  if (typeof uni === 'undefined') return null;\n  try {\n    return uni.getStorageSync(key);\n  } catch (err) {\n    console.warn('read storage failed', err);\n    return null;\n  }\n}\n\nfunction safeSetStorage(key, value) {\n  if (typeof uni === 'undefined') return;\n  try {\n    uni.setStorageSync(key, value);\n  } catch (err) {\n    console.warn('write storage failed', err);\n  }\n}\n\nfunction safeRemoveStorage(key) {\n  if (typeof uni === 'undefined') return;\n  try {\n    uni.removeStorageSync(key);\n  } catch (err) {\n    console.warn('remove storage failed', err);\n  }\n}\n\nexport function getAccessToken() {\n  return safeGetStorage(ACCESS_TOKEN_KEY);\n}\n\nexport function getRefreshToken() {\n  return safeGetStorage(REFRESH_TOKEN_KEY);\n}\n\nexport function setTokens(accessToken, refreshToken) {\n  if (accessToken) {\n    safeSetStorage(ACCESS_TOKEN_KEY, accessToken);\n  } else {\n    safeRemoveStorage(ACCESS_TOKEN_KEY);\n  }\n  if (refreshToken) {\n    safeSetStorage(REFRESH_TOKEN_KEY, refreshToken);\n  } else {\n    safeRemoveStorage(REFRESH_TOKEN_KEY);\n  }\n}\n\nexport function clearTokens() {\n  safeRemoveStorage(ACCESS_TOKEN_KEY);\n  safeRemoveStorage(REFRESH_TOKEN_KEY);\n}\n\nexport function getStoredUser() {\n  return safeGetStorage(USER_CACHE_KEY);\n}\n\nexport function setStoredUser(user) {\n  if (!user) {\n    safeRemoveStorage(USER_CACHE_KEY);\n  } else {\n    safeSetStorage(USER_CACHE_KEY, user);\n  }\n}\n\nfunction buildUrl(url) {\n  if (!url) return API_BASE;\n  return `${API_BASE}${url.startsWith('/') ? url : `/${url}`}`;\n}\n\nfunction doRequest(options) {\n  return new Promise((resolve, reject) => {\n    uni.request({\n      ...options,\n      success: (res) => resolve(res),\n      fail: (err) => reject(err),\n    });\n  });\n}\n\nexport async function request({ url, method = 'GET', data = {}, header = {}, auth = true }) {\n  const finalHeaders = { 'Content-Type': 'application/json', ...header };\n  if (auth) {\n    const token = getAccessToken();\n    if (token) {\n      finalHeaders.Authorization = `Bearer ${token}`;\n    }\n  }\n  const fullUrl = buildUrl(url || '');\n  const res = await doRequest({ url: fullUrl, method, data, header: finalHeaders });\n  const status = res.statusCode;\n\n  if (status === 401) {\n    clearTokens();\n    setStoredUser(null);\n    throw new Error('未登录或登录已过期');\n  }\n  if (status >= 400) {\n    const message = res.data?.message || res.data?.msg || '请求失败';\n    throw new Error(message);\n  }\n\n  const body = res.data;\n  if (body && body.success === false) {\n    throw new Error(body.message || '请求失败');\n  }\n  return body && Object.prototype.hasOwnProperty.call(body, 'data') ? body.data : body;\n}\n\nexport { API_BASE };\n"],"names":["uni"],"mappings":"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"}